<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Map + BLE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body { font-family: Arial; margin: 0; padding: 0; }
  #map { height: 50vh; }
  #panel { padding: 10px; }
  button { padding: 8px 12px; margin: 4px; }
  #devices { margin-top: 6px; }
  #log { font-size: 14px; background: #f7f7f7; padding: 8px; height: 180px; overflow-y: auto; border: 1px solid #ccc; }
</style>
</head>
<body>

<div id="map"></div>
<div id="panel">
  <input id="destination" placeholder="Nh·∫≠p ƒë·ªãa ƒëi·ªÉm ƒë·∫øn..." style="width:70%">
  <button id="btnRoute">üìç T√¨m ƒë∆∞·ªùng</button>
  <hr>
  <button id="btnScan">üîç Qu√©t thi·∫øt b·ªã BLE</button>
  <div id="devices"></div>
  <h4>Log</h4>
  <div id="log"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ================= MAP & ROUTING ================= */
let map = L.map('map').setView([10.762622, 106.660172], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let currentMarker = null;
let routeLine = null;
let myLat = null, myLon = null;

navigator.geolocation.watchPosition(pos => {
  myLat = pos.coords.latitude;
  myLon = pos.coords.longitude;
  if (currentMarker) {
    currentMarker.setLatLng([myLat, myLon]);
  } else {
    currentMarker = L.marker([myLat, myLon]).addTo(map);
  }
}, err => {
  log("‚ö†Ô∏è L·ªói GPS:", err);
}, { enableHighAccuracy: true });

document.getElementById("btnRoute").addEventListener("click", async () => {
  const dest = document.getElementById("destination").value.trim();
  if (!dest || !myLat) {
    log("‚ö†Ô∏è Ch∆∞a c√≥ GPS ho·∫∑c ch∆∞a nh·∫≠p ƒëi·ªÉm ƒë·∫øn");
    return;
  }
  // Geocode ƒëi·ªÉm ƒë·∫øn
  let geoUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(dest)}`;
  let geoData = await fetch(geoUrl).then(r => r.json());
  if (!geoData.length) {
    log("‚ùå Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm");
    return;
  }
  let destLat = parseFloat(geoData[0].lat);
  let destLon = parseFloat(geoData[0].lon);

  // L·∫•y route t·ª´ OSRM
  let routeUrl = `https://router.project-osrm.org/route/v1/driving/${myLon},${myLat};${destLon},${destLat}?overview=full&geometries=geojson&steps=true`;
  let routeData = await fetch(routeUrl).then(r => r.json());
  if (!routeData.routes || !routeData.routes.length) {
    log("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c route");
    return;
  }
  let coords = routeData.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
  if (routeLine) map.removeLayer(routeLine);
  routeLine = L.polyline(coords, { color: 'blue' }).addTo(map);
  map.fitBounds(routeLine.getBounds());

  // G·ª≠i h∆∞·ªõng r·∫Ω ti·∫øp theo
  let nextStep = routeData.routes[0].legs[0].steps[0];
  let instruction = nextStep.maneuver.instruction;
  let distance = nextStep.distance.toFixed(0) + " m";
  log(`üõ£Ô∏è H∆∞·ªõng: ${instruction} - ${distance}`);
  sendData(`${instruction} | ${distance}`);
});

/* ================= BLE SCAN & CONNECT ================= */
const logEl = document.getElementById("log");
function log(...args) {
  console.log(...args);
  logEl.textContent += args.join(" ") + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

const devicesEl = document.getElementById("devices");
let bleDevices = [];
let serviceUuid = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
let writeCharacteristic = null;

document.getElementById("btnScan").addEventListener("click", async () => {
  try {
    log("üîç Y√™u c·∫ßu ch·ªçn thi·∫øt b·ªã BLE...");
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [serviceUuid]
    });
    log(`‚úÖ ƒê√£ ch·ªçn: ${device.name || device.id}`);
    bleDevices.push(device);
    renderDevices();
  } catch (err) {
    log("‚ùå L·ªói:", err);
  }
});

function renderDevices() {
  devicesEl.innerHTML = "";
  bleDevices.forEach(dev => {
    const btn = document.createElement("button");
    btn.textContent = `K·∫øt n·ªëi: ${dev.name || dev.id}`;
    btn.onclick = () => connectToDevice(dev);
    devicesEl.appendChild(btn);
  });
}

async function connectToDevice(device) {
  try {
    log(`üîó K·∫øt n·ªëi t·ªõi ${device.name || device.id}...`);
    const server = await device.gatt.connect();
    log("‚úÖ GATT Connected");
    const service = await server.getPrimaryService(serviceUuid);
    writeCharacteristic = await service.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e");
    log("‚úÖ S·∫µn s√†ng g·ª≠i d·ªØ li·ªáu");
  } catch (err) {
    log("‚ùå K·∫øt n·ªëi l·ªói:", err);
  }
}

async function sendData(text) {
  if (!writeCharacteristic) {
    log("‚ö†Ô∏è Ch∆∞a k·∫øt n·ªëi BLE ƒë·ªÉ g·ª≠i");
    return;
  }
  let enc = new TextEncoder();
  await writeCharacteristic.writeValue(enc.encode(text));
  log("üì§ ƒê√£ g·ª≠i:", text);
}
</script>
</body>
</html>

