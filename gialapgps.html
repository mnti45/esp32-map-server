<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <title>BLE Connect Debug</title>
  <style>
    body{font-family:Arial;margin:20px}
    button{padding:10px 14px;margin:6px}
    #log{white-space:pre-wrap;background:#f7f7f7;padding:10px;border:1px solid #ddd;height:220px;overflow:auto}
  </style>
</head>
<body>
  <h2>BLE Connect Debug</h2>
  <div>
    <button id="btnScan">üîç Qu√©t & Ch·ªçn Thi·∫øt b·ªã</button>
    <button id="btnDisconnect">‚õî Ng·∫Øt k·∫øt n·ªëi</button>
  </div>
  <div>
    <strong>Tr·∫°ng th√°i:</strong> <span id="status">Ch∆∞a k·∫øt n·ªëi</span>
  </div>
  <div>
    <strong>Thi·∫øt b·ªã ƒë√£ ch·ªçn:</strong> <span id="devName">‚Äî</span>
    <br><strong>Service UUID (s·ª≠a n·∫øu c·∫ßn):</strong>
    <input id="serviceUuid" value="6e400001-b5a3-f393-e0a9-e50e24dcca9e" style="width:360px"/>
  </div>
  <h4>Log</h4>
  <div id="log"></div>

<script>
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const devNameEl = document.getElementById('devName');
const btnScan = document.getElementById('btnScan');
const btnDisconnect = document.getElementById('btnDisconnect');

let device = null;
let server = null;
let service = null;
let characteristic = null;

function log(...args){
  console.log(...args);
  logEl.textContent += args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ') + '\n';
  logEl.scrollTop = logEl.scrollHeight;
}

function setStatus(s){ statusEl.textContent = s; log('STATUS:', s); }

// Important: web bluetooth requires this user action to open chooser
btnScan.addEventListener('click', async () => {
  const serviceUuid = document.getElementById('serviceUuid').value.trim().toLowerCase();
  try {
    setStatus('Y√™u c·∫ßu ch·ªçn thi·∫øt b·ªã...');
    // Use acceptAllDevices:true so the OS chooser shows all devices (safer on iOS)
    device = await navigator.bluetooth.requestDevice({
      // filters: [{name: 'ESP32_NAV'}], // you can use filter by name but if not sure, prefer acceptAllDevices
      acceptAllDevices: true,
      optionalServices: [serviceUuid]
    });
    devNameEl.textContent = device.name || device.id;
    setStatus('ƒê√£ ch·ªçn thi·∫øt b·ªã: ' + (device.name || device.id));
    log('Device chosen:', device);

    device.addEventListener('gattserverdisconnected', onDisconnected);

    setStatus('K·∫øt n·ªëi GATT...');
    server = await device.gatt.connect();
    setStatus('K·∫øt n·ªëi GATT th√†nh c√¥ng');

    log('Getting service', serviceUuid);
    service = await server.getPrimaryService(serviceUuid);
    log('Got service', service);

    // Try to get first writable characteristic
    const chars = await service.getCharacteristics();
    log('Characteristics found:', chars.map(c=>c.uuid));
    // You can adjust which characteristic to use. Here we pick first with write property.
    characteristic = chars.find(c => (c.properties.write || c.properties.writeWithoutResponse));
    if (!characteristic) {
      // fallback: try known UUID (6e400002)
      try {
        characteristic = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
      } catch(e){ /* ignore */ }
    }
    if (!characteristic) {
      setStatus('Kh√¥ng t√¨m th·∫•y characteristic ƒë·ªÉ ghi (WRITE).');
      log('No writable characteristic found. Characteristics list above.');
      return;
    }
    log('Using characteristic', characteristic.uuid, 'props:', characteristic.properties);
    setStatus('S·∫µn s√†ng. K·∫øt n·ªëi th√†nh c√¥ng v·ªõi ' + (device.name || device.id));
  } catch (err) {
    setStatus('L·ªói: ' + (err.message || err));
    log('ERROR', err);
  }
});

// Disconnect manual
btnDisconnect.addEventListener('click', async () => {
  if (!device) return setStatus('Ch∆∞a c√≥ thi·∫øt b·ªã.');
  if (device.gatt.connected) {
    device.gatt.disconnect();
    setStatus('ƒê√£ ng·∫Øt k·∫øt n·ªëi (manual).');
  } else {
    setStatus('Thi·∫øt b·ªã ƒë√£ ng·∫Øt k·∫øt n·ªëi.');
  }
});

function onDisconnected(e){
  log('EVENT: device disconnected', e);
  setStatus('Thi·∫øt b·ªã ƒë√£ ng·∫Øt k·∫øt n·ªëi');
  // optional auto-reconnect attempt --- be careful, must be user-driven ideally
  // tryAutoReconnect();
}

// Example function to write a test value (call from console or wire a UI)
async function writeTest(text){
  if (!characteristic) { log('No characteristic ready'); return; }
  try {
    const enc = new TextEncoder();
    await characteristic.writeValue(enc.encode(text));
    log('Wrote:', text);
  } catch(err){
    log('Write error', err);
    setStatus('Write error: ' + (err.message || err));
  }
}

// Expose for console/testing
window.__ble = { device, server, service, characteristic, writeTest };
log('Page loaded. Click "Qu√©t & Ch·ªçn Thi·∫øt b·ªã" to start.');
</script>
</body>
</html>

