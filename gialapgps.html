<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>BLE + OSM Navigation</title>
<style>
  #map { height: 400px; width: 100%; }
  body { font-family: Arial; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
</head>
<body>

<h2>Äiá»u hÆ°á»›ng + Gá»­i dá»¯ liá»‡u qua BLE</h2>

<div>
  <label>Äiá»ƒm Ä‘áº¿n: </label>
  <input type="text" id="destination" placeholder="Nháº­p Ä‘á»‹a chá»‰..."/>
  <button onclick="startNavigation()">TÃ­nh Ä‘Æ°á»ng</button>
</div>

<div>
  <button onclick="scanBLE()">ğŸ” QuÃ©t thiáº¿t bá»‹ BLE</button>
  <select id="deviceList"></select>
  <button onclick="connectSelected()">Káº¿t ná»‘i</button>
</div>

<div id="map"></div>
<div id="status"></div>

<script>
let bleServer, bleService, bleCharacteristic, selectedDevice;
const SERVICE_UUID = "6E400001-B5A3-F393-E0A9-E50E24DCCA9E";
const CHARACTERISTIC_UUID = "6E400002-B5A3-F393-E0A9-E50E24DCCA9E";

let map = L.map('map').setView([0, 0], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

let control = L.Routing.control({
  waypoints: [],
  routeWhileDragging: true
}).addTo(map);

// QuÃ©t cÃ¡c thiáº¿t bá»‹ BLE
async function scanBLE() {
  try {
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [SERVICE_UUID]
    });

    selectedDevice = device;
    let list = document.getElementById("deviceList");
    let option = document.createElement("option");
    option.value = device.id;
    option.textContent = device.name || `Thiáº¿t bá»‹ khÃ´ng tÃªn (${device.id})`;
    list.appendChild(option);
  } catch (err) {
    console.error(err);
  }
}

// Káº¿t ná»‘i thiáº¿t bá»‹ Ä‘Ã£ chá»n
async function connectSelected() {
  if (!selectedDevice) {
    alert("ChÆ°a chá»n thiáº¿t bá»‹");
    return;
  }
  try {
    const server = await selectedDevice.gatt.connect();
    bleServer = server;
    bleService = await server.getPrimaryService(SERVICE_UUID);
    bleCharacteristic = await bleService.getCharacteristic(CHARACTERISTIC_UUID);
    document.getElementById("status").innerText = "âœ… ÄÃ£ káº¿t ná»‘i " + (selectedDevice.name || "Thiáº¿t bá»‹ BLE");
  } catch (err) {
    console.error(err);
  }
}

// Gá»­i dá»¯ liá»‡u BLE
async function sendBLEData(text) {
  if (bleCharacteristic) {
    let encoder = new TextEncoder();
    await bleCharacteristic.writeValue(encoder.encode(text));
  }
}

function startNavigation() {
  if (!navigator.geolocation) {
    alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ GPS");
    return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    let lat = pos.coords.latitude;
    let lon = pos.coords.longitude;

    let dest = document.getElementById("destination").value;
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(dest)}`)
      .then(res => res.json())
      .then(data => {
        if (data.length === 0) {
          alert("KhÃ´ng tÃ¬m tháº¥y Ä‘á»‹a Ä‘iá»ƒm");
          return;
        }
        let lat2 = parseFloat(data[0].lat);
        let lon2 = parseFloat(data[0].lon);

        control.setWaypoints([
          L.latLng(lat, lon),
          L.latLng(lat2, lon2)
        ]);

        control.on('routesfound', function(e) {
          let route = e.routes[0];
          simulateMovement(route.coordinates);
        });
      });
  });
}

function simulateMovement(coords) {
  let i = 0;
  let interval = setInterval(() => {
    if (i >= coords.length - 1) {
      clearInterval(interval);
      sendBLEData("Äáº¿n nÆ¡i");
      return;
    }
    let current = coords[i];
    let next = coords[i+1];
    let dist = map.distance(current, next).toFixed(1);
    let direction = getDirection(current, next);
    let msg = `CÃ²n ${dist}m, ${direction}`;
    sendBLEData(msg);
    i++;
  }, 2000);
}

function getDirection(p1, p2) {
  let dx = p2.lng - p1.lng;
  return dx > 0 ? "ráº½ pháº£i" : "ráº½ trÃ¡i";
}
</script>

</body>
</html>

