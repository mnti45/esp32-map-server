<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<title>BLE Scan & Connect</title>
<style>
  body { font-family: Arial; margin: 20px; }
  button { padding: 8px 12px; margin: 6px; }
  #devices { margin-top: 10px; }
  #log { white-space: pre-wrap; background: #f7f7f7; padding: 10px; border: 1px solid #ddd; height: 200px; overflow: auto; }
</style>
</head>
<body>
<h2>Qu√©t & K·∫øt n·ªëi BLE</h2>
<button id="btnScan">üîç Qu√©t thi·∫øt b·ªã BLE</button>
<div id="devices"></div>
<h4>Log</h4>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(...args) {
  console.log(...args);
  logEl.textContent += args.join(" ") + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

const devicesEl = document.getElementById("devices");

let bleDevices = [];
let serviceUuid = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
let writeCharacteristic = null;

document.getElementById("btnScan").addEventListener("click", async () => {
  try {
    log("üîç Y√™u c·∫ßu ch·ªçn thi·∫øt b·ªã BLE...");
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [serviceUuid]
    });
    log(`‚úÖ ƒê√£ ch·ªçn: ${device.name || device.id}`);

    bleDevices.push(device);
    renderDevices();
  } catch (err) {
    log("‚ùå L·ªói:", err);
  }
});

function renderDevices() {
  devicesEl.innerHTML = "";
  bleDevices.forEach((dev, idx) => {
    const btn = document.createElement("button");
    btn.textContent = `K·∫øt n·ªëi: ${dev.name || dev.id}`;
    btn.onclick = () => connectToDevice(dev);
    devicesEl.appendChild(btn);
  });
}

async function connectToDevice(device) {
  try {
    log(`üîó K·∫øt n·ªëi t·ªõi ${device.name || device.id}...`);
    const server = await device.gatt.connect();
    log("‚úÖ GATT Connected");

    const service = await server.getPrimaryService(serviceUuid);
    log("‚úÖ Service OK");

    writeCharacteristic = await service.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e");
    log("‚úÖ Characteristic OK - S·∫µn s√†ng g·ª≠i d·ªØ li·ªáu");

    // Test g·ª≠i tin
    await sendData("Hello ESP32");
  } catch (err) {
    log("‚ùå K·∫øt n·ªëi l·ªói:", err);
  }
}

async function sendData(text) {
  if (!writeCharacteristic) {
    log("‚ö†Ô∏è Ch∆∞a k·∫øt n·ªëi ƒë·ªÉ g·ª≠i");
    return;
  }
  let enc = new TextEncoder();
  await writeCharacteristic.writeValue(enc.encode(text));
  log("üì§ ƒê√£ g·ª≠i:", text);
}
</script>
</body>
</html>

