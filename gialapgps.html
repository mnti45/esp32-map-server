<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>B·∫£n ƒë·ªì OSRM + GPX</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  #map { height: 80vh; }
  #controls { padding: 10px; background: #f0f0f0; }
  button, input[type=file] { margin: 5px; }
</style>
</head>
<body>

<div id="controls">
  <input type="text" id="start" placeholder="ƒêi·ªÉm xu·∫•t ph√°t"/>
  <input type="text" id="end" placeholder="ƒêi·ªÉm ƒë·∫øn"/>
  <button id="btnRoute">üöó T√≠nh ƒë∆∞·ªùng</button>

  <input type="file" id="gpxFile" accept=".gpx" />
  <button id="btnLoadGPX">üìÇ N·∫°p GPX</button>
</div>

<div id="map"></div>

<pre id="log" style="padding:10px;background:#eee;height:15vh;overflow:auto;"></pre>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([10.762622, 106.660172], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OSM contributors'
}).addTo(map);

let routeLine = null;
let fullRoute = [];
let fullManeuvers = [];

// Ghi log ra m√†n h√¨nh
function log(msg) {
  document.getElementById('log').textContent += msg + "\n";
}

// H√†m b·ªè d·∫•u ti·∫øng Vi·ªát
function removeAccent(str) {
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

// T√≠nh ƒë∆∞·ªùng b·∫±ng OSRM
document.getElementById('btnRoute').addEventListener('click', async () => {
  // N·∫øu ƒë√£ c√≥ GPX, v·∫Ω l·∫°i t·ª´ GPX
  if (fullRoute.length > 0) {
    log("üìÇ ƒêang d√πng d·ªØ li·ªáu GPX (kh√¥ng g·ªçi OSRM)");
    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(fullRoute.map(p => [p.lat, p.lon]), { color: 'green' }).addTo(map);
    map.fitBounds(routeLine.getBounds());
    return;
  }

  const start = document.getElementById('start').value;
  const end = document.getElementById('end').value;
  if (!start || !end) return alert('Nh·∫≠p ƒë·ªß ƒëi·ªÉm xu·∫•t ph√°t v√† ƒëi·ªÉm ƒë·∫øn');

  log("üöó ƒêang g·ªçi OSRM ƒë·ªÉ t√≠nh ƒë∆∞·ªùng...");
  const url = `https://router.project-osrm.org/route/v1/driving/${start};${end}?overview=full&geometries=geojson`;
  const res = await fetch(url);
  const data = await res.json();

  if (data.routes && data.routes.length > 0) {
    const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(coords, { color: 'blue' }).addTo(map);
    map.fitBounds(routeLine.getBounds());
    log("‚úÖ ƒê√£ v·∫Ω tuy·∫øn ƒë∆∞·ªùng b·∫±ng OSRM");
  } else {
    log("‚ùå Kh√¥ng t√¨m th·∫•y tuy·∫øn ƒë∆∞·ªùng");
  }
});

// N√∫t n·∫°p GPX
document.getElementById('btnLoadGPX').addEventListener('click', async () => {
  const fileInput = document.getElementById('gpxFile');
  if (!fileInput.files.length) return alert('Ch·ªçn file GPX tr∆∞·ªõc');

  const file = fileInput.files[0];
  const text = await file.text();
  parseGPX(text);
});

// H√†m ƒë·ªçc & parse file GPX
function parseGPX(gpxText) {
  const parser = new DOMParser();
  const xml = parser.parseFromString(gpxText, "application/xml");

  fullRoute = [];
  fullManeuvers = [];

  // L·∫•y track points (<trkpt>)
  const trkpts = xml.getElementsByTagName("trkpt");
  for (let pt of trkpts) {
    const lat = parseFloat(pt.getAttribute("lat"));
    const lon = parseFloat(pt.getAttribute("lon"));
    fullRoute.push({ lat, lon });
  }

  // L·∫•y route points (<rtept>)
  const rtepts = xml.getElementsByTagName("rtept");
  for (let pt of rtepts) {
    const lat = parseFloat(pt.getAttribute("lat"));
    const lon = parseFloat(pt.getAttribute("lon"));
    let name = "";
    let desc = "";
    if (pt.getElementsByTagName("name")[0]) name = pt.getElementsByTagName("name")[0].textContent;
    if (pt.getElementsByTagName("desc")[0]) desc = pt.getElementsByTagName("desc")[0].textContent;

    fullManeuvers.push({
      lat, lon,
      modifier: name || 'straight',
      name: removeAccent(desc || ''),
      next: ''
    });
  }

  if (fullRoute.length === 0 && fullManeuvers.length > 0) {
    fullRoute = fullManeuvers.map(m => ({ lat: m.lat, lon: m.lon }));
  }

  if (fullRoute.length === 0) {
    alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu t·ªça ƒë·ªô trong file GPX");
    return;
  }

  if (routeLine) map.removeLayer(routeLine);
  routeLine = L.polyline(fullRoute.map(p => [p.lat, p.lon]), { color: 'green' }).addTo(map);
  map.fitBounds(routeLine.getBounds());

  log(`‚úÖ ƒê√£ n·∫°p GPX: ${fullRoute.length} ƒëi·ªÉm, ${fullManeuvers.length} b∆∞·ªõc ƒëi·ªÅu h∆∞·ªõng`);
}

// N·∫øu nh·∫≠p ƒëi·ªÉm m·ªõi th√¨ x√≥a GPX ƒë·ªÉ OSRM ho·∫°t ƒë·ªông
document.getElementById('start').addEventListener('input', () => { fullRoute = []; });
document.getElementById('end').addEventListener('input', () => { fullRoute = []; });

</script>
</body>
</html>
