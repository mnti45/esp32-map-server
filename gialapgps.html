<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Điều hướng & BLE</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { font-family: Arial; margin: 0; padding: 0; }
  #map { height: 70vh; }
  #controls { padding: 10px; background: #f5f5f5; }
  button { margin: 5px; padding: 8px 12px; }
  #log { background: #111; color: #0f0; padding: 10px; height: 20vh; overflow-y: auto; font-size: 14px; }
</style>
</head>
<body>

<div id="map"></div>
<div id="controls">
  <input type="text" id="start" placeholder="Điểm bắt đầu">
  <input type="text" id="end" placeholder="Điểm kết thúc">
  <button id="btnRoute">📍 Tìm đường</button>
  <button id="btnBLE">🔍 Quét & kết nối ESP32</button>
  <button id="btnSendBLE">📤 Gửi dữ liệu cho ESP32</button>
</div>
<pre id="log"></pre>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([10.762622, 106.660172], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OSM contributors'
}).addTo(map);

let routeLine = null;
let fullRoute = [];
let fullManeuvers = [];

// BLE vars
let bleDevice = null;
let bleCharacteristic = null;

// BLE UUIDs của ESP32 (phải trùng với ESP32 code)
const SERVICE_UUID        = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const CHARACTERISTIC_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

function log(msg) {
  document.getElementById('log').textContent += msg + "\n";
  document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
}

function removeAccent(str) {
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

/* ====================== OSRM ====================== */
async function getRoute(startLatLng, endLatLng) {
  const url = `https://router.project-osrm.org/route/v1/driving/${startLatLng.lng},${startLatLng.lat};${endLatLng.lng},${endLatLng.lat}?overview=full&geometries=geojson&steps=true&language=vi`;
  const res = await fetch(url);
  const data = await res.json();

  if (data.routes.length > 0) {
    const route = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
    const maneuvers = data.routes[0].legs[0].steps.map(s => removeAccent(s.maneuver.instruction));

    fullRoute = route;
    fullManeuvers = maneuvers;

    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(route, { color: 'blue' }).addTo(map);
    map.fitBounds(routeLine.getBounds());

    log("✅ Đã tìm thấy tuyến đường");
  } else {
    log("❌ Không tìm thấy tuyến đường");
  }
}

/* ====================== Nút tìm đường ====================== */
document.getElementById('btnRoute').addEventListener('click', async () => {
  const startAddr = document.getElementById('start').value;
  const endAddr = document.getElementById('end').value;

  if (!startAddr || !endAddr) return alert("Nhập đầy đủ điểm bắt đầu và kết thúc");

  const startRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${startAddr}`);
  const startData = await startRes.json();
  const endRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${endAddr}`);
  const endData = await endRes.json();

  if (startData.length > 0 && endData.length > 0) {
    const startLatLng = { lat: parseFloat(startData[0].lat), lng: parseFloat(startData[0].lon) };
    const endLatLng = { lat: parseFloat(endData[0].lat), lng: parseFloat(endData[0].lon) };
    await getRoute(startLatLng, endLatLng);
  } else {
    log("❌ Không tìm thấy địa chỉ");
  }
});

/* ====================== BLE ====================== */
document.getElementById('btnBLE').addEventListener('click', async () => {
  try {
    log("🔍 Đang quét thiết bị BLE...");
    bleDevice = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [SERVICE_UUID]
    });

    bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

    const server = await bleDevice.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

    log(`✅ Đã kết nối tới: ${bleDevice.name}`);

    // Ẩn nút quét BLE khi kết nối thành công
    document.getElementById('btnBLE').style.display = "none";
  } catch (error) {
    log("❌ Lỗi BLE: " + error);
  }
});

function onDisconnected() {
  log("⚠️ Mất kết nối BLE");
  // Hiện lại nút quét BLE khi mất kết nối
  document.getElementById('btnBLE').style.display = "inline-block";
}

document.getElementById('btnSendBLE').addEventListener('click', async () => {
  if (!bleCharacteristic) return alert("Chưa kết nối BLE");

  const data = {
    route: fullRoute,
    maneuvers: fullManeuvers
  };
  const jsonString = JSON.stringify(data);

  try {
    const encoder = new TextEncoder();
    const chunkSize = 200; // BLE packet size limit
    for (let i = 0; i < jsonString.length; i += chunkSize) {
      const chunk = jsonString.substring(i, i + chunkSize);
      await bleCharacteristic.writeValue(encoder.encode(chunk));
    }
    log("📤 Đã gửi dữ liệu điều hướng tới ESP32");
  } catch (error) {
    log("❌ Gửi BLE thất bại: " + error);
  }
});
</script>
</body>
</html>
