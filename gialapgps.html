<!DOCTYPE html><!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Upload GPX v√† g·ª≠i BLE</title>
<style>
  body { font-family: sans-serif; background: #111; color: #eee; text-align: center; padding: 20px; }
  button, input { margin: 10px; padding: 10px; }
  #status { margin-top: 10px; }
</style>
</head>
<body>

<h2>Upload GPX OsmAnd & G·ª≠i cho ESP32</h2>

<input type="file" id="gpxFile" accept=".gpx">
<br>
<button id="connectBtn">üîç Qu√©t & K·∫øt n·ªëi BLE</button>
<button id="sendBtn" disabled>üì§ G·ª≠i route</button>
<div id="status">Ch∆∞a k·∫øt n·ªëi</div>

<script>
const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const CHARACTERISTIC_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

let bleDevice, bleCharacteristic;
let routeData = [];

document.getElementById("connectBtn").addEventListener("click", connectBLE);
document.getElementById("sendBtn").addEventListener("click", sendRoute);
document.getElementById("gpxFile").addEventListener("change", handleFile);

async function connectBLE() {
  try {
    bleDevice = await navigator.bluetooth.requestDevice({
      filters: [{ services: [SERVICE_UUID] }]
    });
    const server = await bleDevice.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

    document.getElementById("status").innerText = "‚úÖ ƒê√£ k·∫øt n·ªëi";
    document.getElementById("connectBtn").style.display = "none";
    document.getElementById("sendBtn").disabled = false;

    bleDevice.addEventListener("gattserverdisconnected", () => {
      document.getElementById("status").innerText = "‚ùå M·∫•t k·∫øt n·ªëi";
      document.getElementById("connectBtn").style.display = "inline-block";
      document.getElementById("sendBtn").disabled = true;
    });
  } catch (err) {
    document.getElementById("status").innerText = "‚ùå L·ªói BLE: " + err;
  }
}

function handleFile(evt) {
  const file = evt.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(e.target.result, "application/xml");
    const trkpts = xmlDoc.getElementsByTagName("trkpt");
    routeData = [];

    for (let i = 0; i < trkpts.length; i++) {
      const lat = parseFloat(trkpts[i].getAttribute("lat"));
      const lon = parseFloat(trkpts[i].getAttribute("lon"));
      routeData.push({ lat, lon });
    }

    document.getElementById("status").innerText = `üìÑ ƒê√£ ƒë·ªçc ${routeData.length} ƒëi·ªÉm t·ª´ GPX`;
  };
  reader.readAsText(file);
}

async function sendRoute() {
  if (!bleCharacteristic || routeData.length === 0) {
    alert("Ch∆∞a c√≥ k·∫øt n·ªëi ho·∫∑c d·ªØ li·ªáu route");
    return;
  }

  const jsonString = JSON.stringify({ route: routeData });
  const encoder = new TextEncoder();
  const bytes = encoder.encode(jsonString);
  const chunkSize = 180; // BLE limit

  for (let i = 0; i < bytes.length; i += chunkSize) {
    const chunk = bytes.slice(i, i + chunkSize);
    await bleCharacteristic.writeValueWithoutResponse(chunk);
    await new Promise(r => setTimeout(r, 50)); // delay tr√°nh ngh·∫Ωn
  }

  document.getElementById("status").innerText = "‚úÖ G·ª≠i route th√†nh c√¥ng";
}
</script>
</body>
</html>

