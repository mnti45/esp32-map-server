<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>BLE + OSM Navigation</title>
<style>
  #map { height: 400px; width: 100%; }
  body { font-family: Arial; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
</head>
<body>

<h2>Điều hướng + Gửi dữ liệu qua BLE</h2>

<div>
  <label>Điểm đến: </label>
  <input type="text" id="destination" placeholder="Nhập địa chỉ..."/>
  <button onclick="startNavigation()">Tính đường</button>
  <button onclick="connectBLE()">Kết nối ESP32</button>
</div>

<div id="map"></div>
<div id="status"></div>

<script>
let bleServer, bleService, bleCharacteristic;
const SERVICE_UUID = "6E400001-B5A3-F393-E0A9-E50E24DCCA9E";
const CHARACTERISTIC_UUID = "6E400002-B5A3-F393-E0A9-E50E24DCCA9E";

let map = L.map('map').setView([0, 0], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

let control = L.Routing.control({
  waypoints: [],
  routeWhileDragging: true
}).addTo(map);

function connectBLE() {
  navigator.bluetooth.requestDevice({
    filters: [{ name: "ESP32_NAV" }],
    optionalServices: [SERVICE_UUID]
  })
  .then(device => device.gatt.connect())
  .then(server => {
    bleServer = server;
    return server.getPrimaryService(SERVICE_UUID);
  })
  .then(service => {
    bleService = service;
    return service.getCharacteristic(CHARACTERISTIC_UUID);
  })
  .then(characteristic => {
    bleCharacteristic = characteristic;
    document.getElementById("status").innerText = "✅ Đã kết nối ESP32";
  })
  .catch(err => console.error(err));
}

function startNavigation() {
  if (!navigator.geolocation) {
    alert("Trình duyệt không hỗ trợ GPS");
    return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    let lat = pos.coords.latitude;
    let lon = pos.coords.longitude;

    let dest = document.getElementById("destination").value;
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(dest)}`)
      .then(res => res.json())
      .then(data => {
        if (data.length === 0) {
          alert("Không tìm thấy địa điểm");
          return;
        }
        let lat2 = parseFloat(data[0].lat);
        let lon2 = parseFloat(data[0].lon);

        control.setWaypoints([
          L.latLng(lat, lon),
          L.latLng(lat2, lon2)
        ]);

        control.on('routesfound', function(e) {
          let route = e.routes[0];
          simulateMovement(route.coordinates);
        });
      });
  });
}

async function sendBLEData(text) {
  if (bleCharacteristic) {
    let encoder = new TextEncoder();
    await bleCharacteristic.writeValue(encoder.encode(text));
  }
}

function simulateMovement(coords) {
  let i = 0;
  let interval = setInterval(() => {
    if (i >= coords.length - 1) {
      clearInterval(interval);
      sendBLEData("Đến nơi");
      return;
    }
    let current = coords[i];
    let next = coords[i+1];
    let dist = map.distance(current, next).toFixed(1);

    let direction = getDirection(current, next);
    let msg = `Còn ${dist}m, ${direction}`;
    sendBLEData(msg);
    i++;
  }, 2000);
}

function getDirection(p1, p2) {
  let dx = p2.lng - p1.lng;
  return dx > 0 ? "rẽ phải" : "rẽ trái";
}
</script>

</body>
</html>

